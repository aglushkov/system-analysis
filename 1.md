
# Домашка №1

## Event storming модель

https://miro.com/app/board/uXjVNN4Acpo=/?share_link_id=477552880418


## Модель данных

https://miro.com/app/board/uXjVNPGHdGU=/?share_link_id=6506402486


## Модель коммуникаций в системе

https://miro.com/app/board/uXjVOzjE5yk=/?share_link_id=387931034159

## Текстовое описание

Команды и события сгруппированы таким образом, чтобы решать какой-то один бизнес процесс
максимально независимо. Каждая группа владеет своим аггрегатом, который создается и изменяется
только в этом контексте.

## Элементы системы:

1. Отдел создания и редактирования услуг (CMS) \
   Менеджеры создают и редактируют услуги. \
   Затем эти услуги через стриминг попадают в магазин услуг (2)

2. Магазин услуг \
   Показывает клиенту доступные услуги, позволяет управлять корзиной (клиент + услуга). \
   Когда клиент решается оформить заказ, делается снапшот его корзины, корзина удаляется и через domain event
   снапшот корзины направляется в (3) Lifecycle заказа

3. Lifecycle заказа \
   Берет корзину клиента, назначает воркера и цену - формирует заказ. \
   Позволяет менять статус заказа воркеру (новый, приступил, завершил) \
   Позволяет менять статус заказа клиенту (отменен, провален, успешно завершен) \
   Позволяет менять статус заказа по крону (провален). \
   При формировании посылает ивент, что новый заказ подготовлен. Это нужно для отдела сборки. \
   При завершении (отменен, выполнен, провален) посылает domain event, что заказ завершен

4. Отдел сборки
   Собирает расходники к заказам. \
   Управляет своим статусом сборки заказа. Не меняет заказ из (3) непосредственно. \
   Воркер когда берет расходники, нажимает кнопку "взял", подписывает что-то. \
   Посылает домаэн ивент, что расходники выданы. Этот ивент нужен в (3), чтобы дать
   возможность воркеру приступить к заказу.

5. История оказанных услуг \
   Хранит все заказы

6. Бухгалтерия Клиентов \
   Считает, сколько денег надо списать с клиента. Списывает деньги по крону. \
   Допускаем, что информация о способе списания денег с клиента попадает сюда автоматически, также
   как и с клиентами, которые автоматически попадают в систему. \
   Показывает клиентам все транзакции и инвойсы. \
   Мы не объединяем клиентскую и воркерскую бухгалтерии в один сервис, хотя они и делают похожие вещи. \
   В будущем могут приходить совершенно разные требования для этих систем.

7. Бухгалтерия Воркеров \
   Считает, сколько денег надо начислить воркеру. Начисляет деньги по крону. \
   Воркеры с кредами, куда начислять деньги, попадают сюда по стриму из отдела по поиску воркеров (8). \
   Показывает воркерам их заработок

8. Отдел поиска воркеров \
   Занимается поиском воркера. Подготовленный воркер стримится во все сервисы, где нужна информация о воркере

9. Отдел проверки качества \
   Получает все завершенные заказы. Управляет формой проверки качества.


## Спорные или критичные места

- Сильно зависим от печенья, воркеры будут по 10 минут простаивать на каждом заказе.
- Плохо продумали, как и когда можно поменять статус заказ на "отменен, провален". Но кажется эта деталь пока не очень критична
  Например, что делать с расходниками, если клиент отменил заказ после их
  выдачи. Или заказ провалился по крону, хотя воркер уже приступил к выполнению.
- Не продумали, что делать при ошибках оплаты, списания

## Размышления по условиям и требованиям:

1) *низкий ТТМ (Time To Market)*;

   - Низкий TTM это понятие относительное и во многом зависит от количества и
     квалификации разработчиков. Мало зависит от архитектуры.

2) *небольшая изначальная нагрузка*

   - Значит, можно начинать с любой архитектуры, но в дальнейшем планируется
     покорение мира, и лучше быть к этому готовыми

3) *критично проверять новые гипотезы по отсеву котов и изменять уже
   существующие с максимальной скоростью и надёжностью*

   - Значит нужно, чтобы эта часть системы была максимально независима.
     Это условие намекает на то, что это должен быть отдельный сервис. Потому что микросервисы
     можно изменять и деплоить независимо. К тому же эта часть системы подвержена DDOS от
     конкурентов, а это еще один плюс за отдельный сервис, чтобы защитить
     кор-функциональсть заказа и выполнения услуг.

4) happy cat box готовы потратить столько, сколько потребуется
   - О таком клиенте можно только мечтать. Главное не делать регистрацию 3 месяца.

5) Команда разработки будет собрана после нашего анализа требуемой системы
   - Надо набрать самых метерых кото-хакеров


### Итоговое решение

 Поскольку большинство элементов системы имеют:
 - свою достаточно специфичную логику
 - большой потенциал для изменений
 - специфичную нагрузку (постоянно, или раз в неделю)
 - возможность выбора более подходящие БД для разных сервисов (реляционная для бухгалтерии, но документо-ориентированная для тестов воркера или описания услуг)

 то выбираем мы **микросервисную архитектуру с асинхронными коммуникациями (TM)**
